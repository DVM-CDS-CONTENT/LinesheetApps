<style>
    .bg-canvas{
        background-color:#EFF0F6!important
    }

    @font-face {
        font-family: "CPN-Regular";
        src: url('./font/CPN-Regular.ttf');
    }
    @font-face {
        font-family: "CPN-Bold";
        src: url('./font/CPN-Bold.ttf');
    }

    body{
        background-color:#EFF0F6!important;
        font-size:12px;
        /* font-family: 'IBM Plex Sans Thai', sans-serif!important; */
        font-family: 'CPN-Regular';
    }
    .f-cpn-bold{
        font-family: 'CPN-Bold'!important;
    }
    .header-product-grouping{
        font-family: 'CPN';
        font-style: normal;
        font-weight: 700;
        font-size: 24px;
        line-height: 38px;
    }
    .breadcrumb-item.select{
        font-family: 'CPN';
        font-style: normal;
        font-weight: 700;
        font-size: 12px;
        line-height: 19px;
        color: #A6192E;

    }

    .breadcrumb-item{
        font-family: 'CPN';
        font-style: normal;
        font-weight: 700;
        font-size: 12px;
        line-height: 19px;

    }

    .input-parent-convert{
        width: 100%;
        background: #FFFFFF;
        border-radius: 5px;
        border:0px;
        margin:0px;
        padding-left: 5px;
        padding-right: 5px;
        color: #787878;
        font-weight: 500;


    }

    .col-input-parent-convert{
        flex: 1 0 1%;
        max-width: 68px!important;
        margin-right:1px;
        margin-left:0px;
        height: 27px;
        padding-right: 5px!important;
        padding-left:5px!important;
    }

    .form-label{
        font-style: normal;
        font-weight: 700;
        font-size: 12px;
        /* line-height: 19px; */
        /* identical to box height */
        color: #6E7191;

    }
    .preview-parent{
        font-style: normal;
        font-weight: 400;
        font-size: 12px;
        line-height: 19px;
        /* identical to box height */
        color: #A2A2A2;
    }

    .form-check .form-check-input {
    float: left;
    /* margin-left: -1.5em!important; */
    width: 61px!important;
    height: 31px!important;
    margin-right: 10px;
    color: #6E7191;
    }

small.form-check-label{
    display: block;
    color: #6E7191;
    margin-left: 30px;
}

label.form-check-label{
    display: -webkit-inline-box;
    color: #6E7191;
    /* font-family: 'CPN-Bold'; */
}

.form-check-input:checked {
    background-color: #4CAF50!important;
    border-color: #4CAF50!important;
}

.form-check-label.warning{
    font-size: 12px;
    color: #FF9800;
    margin-left: 30px;
}

.form-check-label.header{
    color: #6E7191;
    font-weight:500;
}


</style>


<div id="nav_choose_file">
    <div class="nav_input">
        <div class="box_input p-3 shadow-sm border-bottom bg-white">
            <input type="file" id="linesheet_input" accept=".xlsx, .xlsm" onchange="DropFile()"/>
        </div>
</div>

</div>
<div class="row h-100">
    <div class="col-7 border-end">
        <div class="bg-canvas ps-5 ">
            <!-- breadcrumb -->
            <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '>';" class=" pt-5 f-cpn-bold" >
                <ol class="breadcrumb">
                    <li class="breadcrumb-item ">Import</li>
                    <li class="breadcrumb-item ">Linesheet validate</li>
                    <li class="breadcrumb-item ">Cleansing</li>
                    <li class="breadcrumb-item select" aria-current="page">Convert</li>
                </ol>
            </nav>
            <div style="font:24px;" class="header-product-grouping">Linesheet</div>
            <ul>
                <li id='file_name' class="form-label">file_name</li>
                <li id='brand' class="form-label">brand</li>
                <li id='sku' class="form-label">sku</li>
                <li id='template' class="form-label">template</li>
            </ul>
            <!-- header -->
            <div style="font:24px;" class="header-product-grouping">Product grouping</div>
            <small>
                First number of running grouping
            </small>
            <!-- grouping input -->
            <div class="mt-3 row ps-2" style="height: 60px;">

                <div class="col-input-parent-convert">
                    <label for="prefix"  class="form-label">Prefix</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_prefix" value="GR">
                </div>

                <div class="col-input-parent-convert">
                    <label for="prefix" class="form-label">BU</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_bu" value="CDS">
                </div>

                <div class="col-input-parent-convert">
                    <label for="prefix" class="form-label">User ID</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_us_id">
                </div>

                <div class="col-input-parent-convert">
                    <label for="prefix" class="form-label">Year</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_year">
                </div>

                <div class="col-input-parent-convert">
                    <label for="prefix" class="form-label">Month</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_month">
                </div>

                <div class="col-input-parent-convert">
                    <label for="prefix" class="form-label">Running</label>
                    <input type="text" onchange="summary_parent_sku_range()" class="input-parent-convert" id="parent_running">
                </div>
            </div>

            <small class="preview-parent">Preview : <span id="preview_parent_start"></span> - <span id="preview_parent_end">parent_1</span> (<span id="preview_parent_lenght">N</span> SKUs) </small>
            <hr>
            <div style="font:24px;" class="header-product-grouping">Product configurable</div>
            <small>
                Apply setting below to all product
            </small>
            <div class="row mt-3">
                <div class="col-6">
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="product_online">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Enable Product</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Set status of product as default</small>
                    </div>
                    <!-- <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="allow_cc">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Allow CC</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to click and correct</small>
                    </div> -->
                    <!-- <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="allow_cod">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Allow COD</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to show cash on delivery badge</small>
                        <small class="form-check-label warning" for="flexSwitchCheckDefault"><ion-icon name="warning-outline"></ion-icon>Only product price more than 7000 able to COD</small>
                    </div> -->
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" checked type="checkbox" role="switch" id="new">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">New</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Mark product is new, new badge will show on product card PLP and PDP</small>
                    </div>
                    <!-- <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="allow_gift_wrapping">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Allow gift wrapping </label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to gift wrapping</small>
                        <small class="form-check-label warning" for="flexSwitchCheckDefault"><ion-icon name="warning-outline"></ion-icon>Product should be</small>
                    </div> -->
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="allow_installment">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Allow installment</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to show installment badge</small>

                    </div>
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" checked type="checkbox" role="switch" id="enable_on_channel">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Enabled on Chanel CDS </label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Set status enabled on channel of product default as enabled on CDS</small>
                    </div>
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" checked type="checkbox" role="switch" id="can_return">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Can Return</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to return after sale</small>
                    </div>
                    <div class="form-check form-switch m-2 mb-4">
                        <input class="form-check-input" checked type="checkbox" role="switch" id="can_exchange">
                        <label class="form-check-label header fw-bold" for="flexSwitchCheckDefault">Can Exchange</label>
                        <small class="form-check-label" for="flexSwitchCheckDefault">Allow product to exchange after sale</small>
                        <small class="form-check-label warning" for="flexSwitchCheckDefault"><ion-icon name="warning-outline"></ion-icon>Except MKP prduct</small>
                    </div>
                </div>
                <div class="col-6">

                    <!-- <div class="row ms-2 me-2 mt-3">
                        <div class="col">
                            <label class="form-check-label header w-100 fw-bold" for="flexSwitchCheckDefault" id="bu">BU</label>
                            <small class=" w-100" for="flexSwitchCheckDefault">Product business unit</small>
                        </div>
                        <div class="col">
                            <select class="form-select" aria-label="Default select example">
                                <option value="CDS">CDS</option>
                                <option value="MJT">MJT</option>
                            </select>
                        </div>
                    </div> -->
                    <div class="row ms-2 me-2 mt-3">
                        <div class="col">
                            <label class="form-check-label header w-100 fw-bold" for="flexSwitchCheckDefault" >Job number</label>
                            <small class=" w-100" for="flexSwitchCheckDefault">Fill content job running</small>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="job_number">
                        </div>
                    </div>
                    <div class="row ms-2 me-2 mt-3">
                        <div class="col">
                            <label class="form-check-label header w-100 fw-bold" for="flexSwitchCheckDefault" >Launch date</label>
                            <small class=" w-100" for="flexSwitchCheckDefault">Effective date of product to enable on website</small>
                        </div>
                        <div class="col">
                            <input type="date" class="form-control" id="launch_date">
                        </div>
                    </div>
                    <div class="row ms-2 me-2 mt-3">
                        <div class="col">
                            <label class="form-check-label header w-100 fw-bold" for="flexSwitchCheckDefault">Sheet name</label>
                            <small class=" w-100" for="flexSwitchCheckDefault">Select sheet in linesheet to convert</small>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="sheet_name" aria-label="Default select example" value="IM FORM">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-5 bg-white" style="padding-top:80px;padding-left:50px;padding-right:50px">
        <div class="d-flex bd-highlight" >
            <div class="p-2 flex-grow-1 bd-highlight" style="place-self: center;">
                <div style="font-size:24px;" class="header-product-grouping">
                    Convert to PIM template
                </div>
            </div>
            <div class="p-2 bd-highlight convert_running">
                <button type="button" class=" btn btn-dark" onclick="handleFileChange()" id="convert_running" style="width: 242px;text-align-last: left;font-weight: 500;height:50px">
                    <div class="d-flex bd-highlight" >
                        <div class="p-2 flex-grow-1 bd-highlight">
                             <span>Start Convert</span>
                        </div>
                        <div class="p-2 bd-highlight">
                            <ion-icon name="play-forward-outline" style="font-size: 25px;"></ion-icon>
                        </div>
                    </div>
                </button>
            </div>
          </div>

            <!-- layer change -->
            <div id="convert_running">
                    <!-- File name -->
            </div>
            <div id="convert_logs" class="border-1" style="height: 450px;overflow: auto;">
                Logs convert
            </div>
            <div id="result_convert" class="border-1">

            </div>




    </div>
</div>
<script>

    function convertExcelToJsonTransposedFile(filePath,sheet_name) {
        var workbook = XLSX.readFile(filePath);
        var worksheet = workbook.Sheets[sheet_name];
        var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        var headers = jsonData[0];
        var rows = jsonData.slice(1);
        var transposedData = rows.map(row => {
            var rowData = {};
            row.forEach((cellValue, index) => {
                rowData[headers[index]] = cellValue;
            });
            return rowData;
        });
   }
   function DropFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const fileContent = e.target.result;

            // Simulate saving to a folder named 'tmp' on the client side
            const folderName = 'tmp';
            const fileName = file.name;

            // Create a Blob with the file content
            const blob = new Blob([fileContent], { type: 'application/octet-stream' });

            // Create a download link
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);

            // Use the simulated folder path as the download filename
            link.download = `${folderName}/${fileName}`;

            // Append the link to the body
            document.body.appendChild(link);

            // Trigger the click event to start the download
            link.click();

            // Remove the link from the DOM
            document.body.removeChild(link);
        };
        reader.readAsText(file);
    } else {
        console.error('No file selected.');
    }
}

    var linesheet_file_path = sessionStorage.getItem('linesheet_file_path');
    var IN_LINK_DATA = convertExcelToJsonTransposed(linesheet_file_path,'IN_LINK_DATA');

    function show_variable_file(){
        document.getElementById("brand").innerHTML =  get_linesheet_information('brand');
        document.getElementById("sku").innerHTML =  get_linesheet_information('sku')+' SKUs';
        document.getElementById("template").innerHTML =  get_linesheet_information('template');
    }

    show_variable_file();



</script>


<script>
    // $("#nav_choose_file").load('page/linesheet/asset/nav_choose_file.html');

    function summary_parent_sku_range(){

        parent_prefix = document.getElementById("parent_prefix").value
        parent_bu = document.getElementById("parent_bu").value
        parent_us_id = document.getElementById("parent_us_id").value
        parent_year = document.getElementById("parent_year").value
        parent_month = document.getElementById("parent_month").value
        parent_running = document.getElementById("parent_running").value

        parent_sku_display =parent_prefix+parent_bu+parent_us_id+parent_year+parent_month+parent_running
        document.getElementById("preview_parent_start").innerText = parent_sku_display

    }

    var XLSX = require('xlsx');
    var { PythonShell } = require('python-shell');
    var os = require('os');
    var path = require('path');
    var fs = require('fs');

  // Function to handle file input change
//   document.getElementById('linesheet_input').files[0] = sessionStorage.getItem('linesheet_file_path');

    function revealFileInExplorer(filePath) {
    var url = 'file://' + filePath;
    window.open(url, '_blank');
    }

    function handleFileChange() {
    Notiflix.Block.standard('.convert_running');
      console.log('call handleFileChange');
    //   const file = event.target.files[0];
    //   const file= sessionStorage.getItem('linesheet_file_path')
    //   const reader = new FileReader();

    //   reader.onload = function (e) {
        // const data = new Uint8Array(e.target.result);
        const file= sessionStorage.getItem('linesheet_file_path')
        // const workbook = XLSX.read(data, { type: 'array' });
        const workbook = XLSX.readFile(file);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 0 ,defval: ''});

        // Remove rows 2 to 11
        jsonData.splice(0, 11);

        jsonData = jsonData.filter(row => row['ibc'] !== '');
       // Find the columns to delete


        // const columnsToDelete = Object.keys(jsonData[0]).filter(key => key.startsWith('__EMPTY'));

        // Remove the columns from each row in the jsonData
        jsonData = jsonData.map(row => {
        // columnsToDelete.forEach(column => {
        //     delete row[column];
        // });

        return row;
        });

        console.log('Excel file converted to JSON:');
        console.log(jsonData);

        // Convert JSON to string
        const jsonString = JSON.stringify(jsonData);

        // Create a JSON file in the temporary directory
        const tempDir = os.tmpdir();
        const filePath = path.join(tempDir, 'temp_spear_convert.json');
        fs.writeFileSync(filePath, jsonString);

        //get data from elements
        var product_online = document.getElementById("product_online").checked;
        var enable_on_channel = document.getElementById("enable_on_channel").checked;

        // var allow_cc = document.getElementById("allow_cc").checked;
        // var allow_cod = document.getElementById("allow_cod").checked;
        var new_in = document.getElementById("new").checked;
        // var allow_gift_wrapping = document.getElementById("allow_gift_wrapping").checked;
        var allow_installment = document.getElementById("allow_installment").checked;
        var can_return = document.getElementById("can_return").checked;
        var can_exchange = document.getElementById("can_exchange").checked;
        // var bu = document.getElementById("bu").value
        var job_number = document.getElementById("job_number").value
        // var product_status = document.getElementById("product_status").value
        var launch_date = document.getElementById("launch_date").value
        var sheet_name = document.getElementById("sheet_name").value

        var parent_prefix = document.getElementById("parent_prefix").value
        var parent_bu = document.getElementById("parent_bu").value
        var parent_us_id = document.getElementById("parent_us_id").value
        var parent_year = document.getElementById("parent_year").value
        var parent_month = document.getElementById("parent_month").value
        var parent_running = document.getElementById("parent_running").value

        var template = document.getElementById("template").innerHTML

        //clear log
        document.getElementById('convert_logs').innerHTML="";
        document.getElementById('result_convert').innerHTML ="";
        var_send_to_validate=[sessionStorage.getItem('linesheet_file_path')]
        var_send_to_convert = [
                                path.join(tempDir, 'temp_spear_convert.json'),
                                parent_prefix,
                                parent_bu,
                                parent_us_id,
                                parent_year,
                                parent_month,
                                parent_running,
                                product_online,
                                enable_on_channel,
                                // allow_cc,
                                // allow_cod,
                                new_in,
                                // allow_gift_wrapping,
                                allow_installment,
                                can_return,
                                can_exchange,
                                job_number,
                                // product_status,
                                launch_date,
                                sheet_name,
                                template
                            ]

        // start validation using VBA on files
        new PythonShell(path.join(__dirname,`../src/page/linesheet/convertor/vba_caller.py`), { args: var_send_to_validate}  )
        .on('error', err => {console.error('An error occurred while running the Python script:', err);})
        .on('stderr', message => {
            console.error('Received error message:', message);
            if(message.includes('Warning')==false){
                Notiflix.Report.warning(
                    'Warning',
                    message,
                    'Okay',
                );

            }else{
                Notiflix.Report.warning(
                    'Warning',
                     message,
                    'Okay',
                );
            }
        })
        .on('close', message => {
            convert_logs = document.getElementById('convert_logs').innerHTML;

        })
        .on('message', message => {
            if(message.includes("Error")){
                message_style='<li class="text-danger m-1  fw-bold"><ion-icon name="alert-circle-outline" class="me-1"></ion-icon>'+message+'</li>'

            }else if(message.includes("Warning")){
                message_style='<li class="text-warning m-1  fw-bold"><ion-icon name="warning-outline" class="me-1"></ion-icon>'+message+'</li>'
            }else if(message.includes("Passed")){
                message_style='<li class="text-success m-1  fw-bold"><ion-icon name="checkmark-outline" class="me-1"></ion-icon>'+message+'</li>'
            }
            else{
                message_style='<li class="text-dark m-1  fw-bold"><ion-icon name="information-circle-outline" class="me-1"></ion-icon>'+message+'</li>'
            }
            if(message!=''){
                document.getElementById('convert_logs').innerHTML = document.getElementById('convert_logs').innerHTML + message_style

                // start convert
                new PythonShell(path.join(__dirname,`../src/page/linesheet/convertor/main.py`), { args: var_send_to_convert}  )
                        .on('error', err => {console.error('An error occurred while running the Python script:', err);})
                        .on('stderr', message => {
                            console.error('Received error message:', message);
                            if(message.includes('Warning')==false){
                                Notiflix.Report.warning(
                                    'Warning',
                                    message,
                                    'Okay',
                                );

                            }else{
                                Notiflix.Report.warning(
                                    'Warning',
                                    message,
                                    'Okay',
                                );
                            }
                        })
                        .on('close', message => {
                            convert_logs = document.getElementById('convert_logs').innerHTML;

                            var currentURL = window.location.href;
                            var basePath = currentURL.substring(0, currentURL.lastIndexOf('/'));
                            var minusOnePath = basePath.substring(0, basePath.lastIndexOf('/'));
                            var minusOnePath = minusOnePath.substring(0, minusOnePath.lastIndexOf('/'));
                            var minusOnePath = minusOnePath.substring(0, minusOnePath.lastIndexOf('/'));

                            download_bt= `
                            <div class="dropdown">
                                <a class="btn btn-sm btn-success dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">Open the template</a>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                    <li><a class="dropdown-item" onclick="revealInFileExplorer(&#39;`+minusOnePath+`/converted&#39;)">Reveal in File Explorer</a></li>
                                </ul>
                            </div>`;

                            document.getElementById('result_convert').innerHTML = download_bt;

                            Notiflix.Block.remove('.convert_running');

                        })
                        .on('message', message => {
                            if(message.includes("Error")){
                                message_style='<li class="text-danger m-1 fw-bold"><ion-icon name="alert-circle-outline" class="me-1"></ion-icon>'+message+'</li>'

                            }else if(message.includes("Warning")){
                                message_style='<li class="text-warning m-1 fw-bold"><ion-icon name="warning-outline" class="me-1"></ion-icon>'+message+'</li>'
                            }else if(message.includes("Success")){
                                message_style='<li class="text-success m-1 fw-bold"><ion-icon name="checkmark-outline" class="me-1"></ion-icon>'+message+'</li>'
                            }
                            else{
                                message_style='<li class="text-dark m-1  fw-bold"><ion-icon name="information-circle-outline" class="me-1"></ion-icon>'+message+'</li>'
                            }
                            if(message!=''){
                                document.getElementById('convert_logs').innerHTML = document.getElementById('convert_logs').innerHTML + message_style

                            }
                        })
                    ;
            }
        })


    }

</script>


